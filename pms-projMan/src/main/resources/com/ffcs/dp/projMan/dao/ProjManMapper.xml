<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ffcs.dp.projectManage.dao.ProjManMapper">

	<!--查找项目列表-->
	<select id="listProject" resultType="ProjManEntity" parameterType="Map">
		with ss as
		 (select t.proj_id,
				 (select count(1)
					from pms_proj_task_check_item
				   where state = 1
					 and task_id = t.task_id) compCheck,
				 (select count(1)
					from pms_proj_task_check_item
				   where task_id = t.task_id) allCheck
			from pms_proj_task t)
		select i.proj_id,
			   i.proj_name,
			   i.belo_proj_group,
			   i.proj_type,
			   (select count(1)
				  from pms_proj_risk_issue r
				 where r.state = 0
				   and r.proj_id = i.proj_id) risk_Item,
			   (select count(1)
				  from pms_proj_task t
				 where t.state != '2'
				   and t.parent_task is null
				   and t.proj_id = i.proj_id) un_Finish_Task,
			   (select trunc((sum(ss.compCheck)/sum(ss.allCheck)*100), 2)
				  from ss
				 where ss.proj_id = i.proj_id) complet_Rate
		  from pms_project_info i
		 where i.state = 0
           and i.belo_proj_group = #{group}
		   and i.proj_type = #{type}
		<if test=" keyword != '' ">
		   and i.proj_name like '%' || #{keyword} || '%'
		</if>
	</select>




	<!--查找已归档项目列表-->
	<select id="listArchiveProject" resultType="ProjManEntity" parameterType="Map">
        select i.proj_id,
               i.proj_name,
               i.belo_proj_group,
               i.proj_type,
               i.start_date,
               i.end_date,
               (select username
                  from pms_sys_user
                 where user_id = s.BIG_PROJ_MANAGER) bigProjManager
          from pms_project_info i
          left join pms_proj_stakeholder s
            on i.proj_id = s.proj_id
         where i.state = 1
        <if test=" group != '' ">
            and i.belo_proj_group = #{group}
        </if>
        <if test=" type != '' ">
		  and i.proj_type = #{type}
        </if>
		<if test=" keyword != '' ">
			and i.proj_name like '%' || #{keyword} || '%'
		</if>
	</select>

</mapper>
